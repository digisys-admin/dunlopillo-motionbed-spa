<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS í…ŒìŠ¤íŠ¸ ë„êµ¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #666; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .warning { background: #ffc107; color: #333; }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 15px 0;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ CORS í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
        <p><strong>ëª©í‘œ:</strong> Google Apps Script APIì™€ì˜ CORS ë¬¸ì œ ë‹¨ê³„ë³„ í•´ê²°</p>
        
        <div class="step">
            <h3>í˜„ì¬ API URL</h3>
            <input type="text" id="apiUrl" style="width: 100%; padding: 8px; margin: 5px 0;" 
                   value="https://script.google.com/macros/s/AKfycbx7O8Skuv4TA0M2z5LmDmVfE1rQ6vI8LwcZrg5eBcc0sKbx5yEP7TUAsznx_vqjVT60pA/exec">
        </div>
    </div>

    <div class="container">
        <h2>1ë‹¨ê³„: ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <div class="step">
            <h4>ğŸŒ GET ìš”ì²­ (ë¸Œë¼ìš°ì € í˜¸í™˜ì„±) <span id="step1-status" class="status pending">ëŒ€ê¸°ì¤‘</span></h4>
            <button class="button" onclick="testStep1()">GET ìš”ì²­ í…ŒìŠ¤íŠ¸</button>
            <div id="step1-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>2ë‹¨ê³„: CORS Preflight í…ŒìŠ¤íŠ¸</h2>
        <div class="step">
            <h4>âš¡ OPTIONS ìš”ì²­ (CORS ì‚¬ì „ ê²€ì‚¬) <span id="step2-status" class="status pending">ëŒ€ê¸°ì¤‘</span></h4>
            <button class="button" onclick="testStep2()">OPTIONS ìš”ì²­ í…ŒìŠ¤íŠ¸</button>
            <div id="step2-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>3ë‹¨ê³„: ë‹¨ìˆœ POST í…ŒìŠ¤íŠ¸</h2>
        <div class="step">
            <h4>ğŸ“¤ POST ìš”ì²­ (ê¸°ë³¸ í—¤ë”) <span id="step3-status" class="status pending">ëŒ€ê¸°ì¤‘</span></h4>
            <button class="button" onclick="testStep3()">ë‹¨ìˆœ POST í…ŒìŠ¤íŠ¸</button>
            <div id="step3-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>4ë‹¨ê³„: ê³ ê¸‰ POST í…ŒìŠ¤íŠ¸</h2>
        <div class="step">
            <h4>ğŸš€ POST ìš”ì²­ (JSON Content-Type) <span id="step4-status" class="status pending">ëŒ€ê¸°ì¤‘</span></h4>
            <button class="button" onclick="testStep4()">ê³ ê¸‰ POST í…ŒìŠ¤íŠ¸</button>
            <div id="step4-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>5ë‹¨ê³„: ëŒ€ì•ˆ ë°©ë²• í…ŒìŠ¤íŠ¸</h2>
        <div class="step">
            <h4>ğŸ”„ JSONP ë°©ì‹ <span id="step5-status" class="status pending">ëŒ€ê¸°ì¤‘</span></h4>
            <button class="button" onclick="testStep5()">JSONP í…ŒìŠ¤íŠ¸</button>
            <div id="step5-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š ì¢…í•© ê²°ê³¼</h2>
        <button class="button success" onclick="runAllTests()">ğŸ”¥ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <button class="button warning" onclick="clearResults()">ğŸ—‘ï¸ ê²°ê³¼ ì´ˆê¸°í™”</button>
        <div id="summary" class="result"></div>
    </div>

    <script>
        let testResults = {
            step1: null,
            step2: null,
            step3: null,
            step4: null,
            step5: null
        };

        function getApiUrl() {
            return document.getElementById('apiUrl').value.trim();
        }

        function updateStatus(step, status, message = '') {
            const statusEl = document.getElementById(`step${step}-status`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = message || status;
        }

        function showResult(step, content) {
            const resultEl = document.getElementById(`step${step}-result`);
            resultEl.textContent = content;
            resultEl.style.display = 'block';
        }

        // 1ë‹¨ê³„: GET ìš”ì²­ í…ŒìŠ¤íŠ¸
        async function testStep1() {
            updateStatus(1, 'pending', 'í…ŒìŠ¤íŠ¸ ì¤‘...');
            try {
                const response = await fetch(getApiUrl(), {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                };
                
                testResults.step1 = result;
                updateStatus(1, result.success ? 'success' : 'error', 
                           result.success ? 'ì„±ê³µ' : `ì‹¤íŒ¨ (${result.status})`);
                showResult(1, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step1 = { success: false, error: error.message };
                updateStatus(1, 'error', 'ì‹¤íŒ¨');
                showResult(1, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // 2ë‹¨ê³„: OPTIONS ìš”ì²­ í…ŒìŠ¤íŠ¸
        async function testStep2() {
            updateStatus(2, 'pending', 'í…ŒìŠ¤íŠ¸ ì¤‘...');
            try {
                const response = await fetch(getApiUrl(), {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                testResults.step2 = result;
                updateStatus(2, result.success ? 'success' : 'error', 
                           result.success ? 'ì„±ê³µ' : `ì‹¤íŒ¨ (${result.status})`);
                showResult(2, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step2 = { success: false, error: error.message };
                updateStatus(2, 'error', 'ì‹¤íŒ¨');
                showResult(2, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // 3ë‹¨ê³„: ë‹¨ìˆœ POST í…ŒìŠ¤íŠ¸
        async function testStep3() {
            updateStatus(3, 'pending', 'í…ŒìŠ¤íŠ¸ ì¤‘...');
            try {
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: 'test=simple',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                };
                
                testResults.step3 = result;
                updateStatus(3, result.success ? 'success' : 'error', 
                           result.success ? 'ì„±ê³µ' : `ì‹¤íŒ¨ (${result.status})`);
                showResult(3, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step3 = { success: false, error: error.message };
                updateStatus(3, 'error', 'ì‹¤íŒ¨');
                showResult(3, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // 4ë‹¨ê³„: ê³ ê¸‰ POST í…ŒìŠ¤íŠ¸
        async function testStep4() {
            updateStatus(4, 'pending', 'í…ŒìŠ¤íŠ¸ ì¤‘...');
            try {
                const testData = {
                    tabletId: 'CORS_TEST',
                    userId: 'TEST_USER',
                    isTest: true
                };
                
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData,
                    requestData: testData
                };
                
                testResults.step4 = result;
                updateStatus(4, result.success ? 'success' : 'error', 
                           result.success ? 'ì„±ê³µ' : `ì‹¤íŒ¨ (${result.status})`);
                showResult(4, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step4 = { success: false, error: error.message };
                updateStatus(4, 'error', 'ì‹¤íŒ¨');
                showResult(4, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // 5ë‹¨ê³„: JSONP í…ŒìŠ¤íŠ¸
        function testStep5() {
            updateStatus(5, 'pending', 'í…ŒìŠ¤íŠ¸ ì¤‘...');
            
            const callbackName = 'jsonpCallback' + Date.now();
            const script = document.createElement('script');
            const timeout = setTimeout(() => {
                testResults.step5 = { success: false, error: 'JSONP ìš”ì²­ ì‹œê°„ ì´ˆê³¼' };
                updateStatus(5, 'error', 'ì‹œê°„ ì´ˆê³¼');
                showResult(5, 'JSONP ìš”ì²­ì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.head.removeChild(script);
                delete window[callbackName];
            }, 10000);
            
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                testResults.step5 = { success: true, data: data };
                updateStatus(5, 'success', 'ì„±ê³µ');
                showResult(5, JSON.stringify(data, null, 2));
                document.head.removeChild(script);
                delete window[callbackName];
            };
            
            script.src = `${getApiUrl()}?callback=${callbackName}`;
            script.onerror = function() {
                clearTimeout(timeout);
                testResults.step5 = { success: false, error: 'JSONP ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨' };
                updateStatus(5, 'error', 'ì‹¤íŒ¨');
                showResult(5, 'JSONP ë°©ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                document.head.removeChild(script);
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runAllTests() {
            for (let i = 1; i <= 5; i++) {
                if (i === 5) {
                    testStep5();
                    await new Promise(resolve => setTimeout(resolve, 3000));
                } else {
                    await window[`testStep${i}`]();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            updateSummary();
        }

        // ê²°ê³¼ ì´ˆê¸°í™”
        function clearResults() {
            testResults = { step1: null, step2: null, step3: null, step4: null, step5: null };
            for (let i = 1; i <= 5; i++) {
                updateStatus(i, 'pending', 'ëŒ€ê¸°ì¤‘');
                document.getElementById(`step${i}-result`).style.display = 'none';
            }
            document.getElementById('summary').textContent = '';
        }

        // ì¢…í•© ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateSummary() {
            const summary = document.getElementById('summary');
            const successCount = Object.values(testResults).filter(r => r && r.success).length;
            const totalCount = Object.values(testResults).filter(r => r !== null).length;
            
            let summaryText = `ğŸ“Š í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${successCount}/${totalCount} ì„±ê³µ\n\n`;
            
            Object.entries(testResults).forEach(([step, result]) => {
                if (result) {
                    const stepNum = step.replace('step', '');
                    const status = result.success ? 'âœ…' : 'âŒ';
                    summaryText += `${status} ${stepNum}ë‹¨ê³„: ${result.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\n`;
                }
            });
            
            if (testResults.step1 && testResults.step1.success) {
                summaryText += '\nğŸ‰ GET ìš”ì²­ ì„±ê³µ! APIê°€ ì‘ë™í•©ë‹ˆë‹¤.';
            }
            
            if (testResults.step4 && testResults.step4.success) {
                summaryText += '\nğŸš€ POST ìš”ì²­ ì„±ê³µ! CORS ë¬¸ì œ í•´ê²°ë¨!';
            } else if (testResults.step3 && testResults.step3.success) {
                summaryText += '\nâš ï¸ ë‹¨ìˆœ POSTëŠ” ì‘ë™í•˜ì§€ë§Œ JSON POSTê°€ ì‹¤íŒ¨. í—¤ë” ë¬¸ì œì¼ ìˆ˜ ìˆìŒ.';
            }
            
            summary.textContent = summaryText;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CORS í…ŒìŠ¤íŠ¸ ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ');
        });
    </script>
</body>
</html>
