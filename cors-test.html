<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS 테스트 도구</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #666; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .warning { background: #ffc107; color: #333; }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 15px 0;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 CORS 테스트 도구</h1>
        <p><strong>목표:</strong> Google Apps Script API와의 CORS 문제 단계별 해결</p>
        
        <div class="step">
            <h3>현재 API URL</h3>
            <input type="text" id="apiUrl" style="width: 100%; padding: 8px; margin: 5px 0;" 
                   value="https://script.google.com/macros/s/AKfycbx7O8Skuv4TA0M2z5LmDmVfE1rQ6vI8LwcZrg5eBcc0sKbx5yEP7TUAsznx_vqjVT60pA/exec">
        </div>
    </div>

    <div class="container">
        <h2>1단계: 기본 연결 테스트</h2>
        <div class="step">
            <h4>🌐 GET 요청 (브라우저 호환성) <span id="step1-status" class="status pending">대기중</span></h4>
            <button class="button" onclick="testStep1()">GET 요청 테스트</button>
            <div id="step1-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>2단계: CORS Preflight 테스트</h2>
        <div class="step">
            <h4>⚡ OPTIONS 요청 (CORS 사전 검사) <span id="step2-status" class="status pending">대기중</span></h4>
            <button class="button" onclick="testStep2()">OPTIONS 요청 테스트</button>
            <div id="step2-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>3단계: 단순 POST 테스트</h2>
        <div class="step">
            <h4>📤 POST 요청 (기본 헤더) <span id="step3-status" class="status pending">대기중</span></h4>
            <button class="button" onclick="testStep3()">단순 POST 테스트</button>
            <div id="step3-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>4단계: 고급 POST 테스트</h2>
        <div class="step">
            <h4>🚀 POST 요청 (JSON Content-Type) <span id="step4-status" class="status pending">대기중</span></h4>
            <button class="button" onclick="testStep4()">고급 POST 테스트</button>
            <div id="step4-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>5단계: 대안 방법 테스트</h2>
        <div class="step">
            <h4>🔄 JSONP 방식 <span id="step5-status" class="status pending">대기중</span></h4>
            <button class="button" onclick="testStep5()">JSONP 테스트</button>
            <div id="step5-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>📊 종합 결과</h2>
        <button class="button success" onclick="runAllTests()">🔥 전체 테스트 실행</button>
        <button class="button warning" onclick="clearResults()">🗑️ 결과 초기화</button>
        <div id="summary" class="result"></div>
    </div>

    <script>
        let testResults = {
            step1: null,
            step2: null,
            step3: null,
            step4: null,
            step5: null
        };

        function getApiUrl() {
            return document.getElementById('apiUrl').value.trim();
        }

        function updateStatus(step, status, message = '') {
            const statusEl = document.getElementById(`step${step}-status`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = message || status;
        }

        function showResult(step, content) {
            const resultEl = document.getElementById(`step${step}-result`);
            resultEl.textContent = content;
            resultEl.style.display = 'block';
        }

        // 1단계: GET 요청 테스트
        async function testStep1() {
            updateStatus(1, 'pending', '테스트 중...');
            try {
                const response = await fetch(getApiUrl(), {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                };
                
                testResults.step1 = result;
                updateStatus(1, result.success ? 'success' : 'error', 
                           result.success ? '성공' : `실패 (${result.status})`);
                showResult(1, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step1 = { success: false, error: error.message };
                updateStatus(1, 'error', '실패');
                showResult(1, `오류: ${error.message}`);
            }
        }

        // 2단계: OPTIONS 요청 테스트
        async function testStep2() {
            updateStatus(2, 'pending', '테스트 중...');
            try {
                const response = await fetch(getApiUrl(), {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                testResults.step2 = result;
                updateStatus(2, result.success ? 'success' : 'error', 
                           result.success ? '성공' : `실패 (${result.status})`);
                showResult(2, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step2 = { success: false, error: error.message };
                updateStatus(2, 'error', '실패');
                showResult(2, `오류: ${error.message}`);
            }
        }

        // 3단계: 단순 POST 테스트
        async function testStep3() {
            updateStatus(3, 'pending', '테스트 중...');
            try {
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    body: 'test=simple',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                };
                
                testResults.step3 = result;
                updateStatus(3, result.success ? 'success' : 'error', 
                           result.success ? '성공' : `실패 (${result.status})`);
                showResult(3, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step3 = { success: false, error: error.message };
                updateStatus(3, 'error', '실패');
                showResult(3, `오류: ${error.message}`);
            }
        }

        // 4단계: 고급 POST 테스트
        async function testStep4() {
            updateStatus(4, 'pending', '테스트 중...');
            try {
                const testData = {
                    tabletId: 'CORS_TEST',
                    userId: 'TEST_USER',
                    isTest: true
                };
                
                const response = await fetch(getApiUrl(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = responseText;
                }
                
                const result = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData,
                    requestData: testData
                };
                
                testResults.step4 = result;
                updateStatus(4, result.success ? 'success' : 'error', 
                           result.success ? '성공' : `실패 (${result.status})`);
                showResult(4, JSON.stringify(result, null, 2));
                
            } catch (error) {
                testResults.step4 = { success: false, error: error.message };
                updateStatus(4, 'error', '실패');
                showResult(4, `오류: ${error.message}`);
            }
        }

        // 5단계: JSONP 테스트
        function testStep5() {
            updateStatus(5, 'pending', '테스트 중...');
            
            const callbackName = 'jsonpCallback' + Date.now();
            const script = document.createElement('script');
            const timeout = setTimeout(() => {
                testResults.step5 = { success: false, error: 'JSONP 요청 시간 초과' };
                updateStatus(5, 'error', '시간 초과');
                showResult(5, 'JSONP 요청이 시간 초과되었습니다.');
                document.head.removeChild(script);
                delete window[callbackName];
            }, 10000);
            
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                testResults.step5 = { success: true, data: data };
                updateStatus(5, 'success', '성공');
                showResult(5, JSON.stringify(data, null, 2));
                document.head.removeChild(script);
                delete window[callbackName];
            };
            
            script.src = `${getApiUrl()}?callback=${callbackName}`;
            script.onerror = function() {
                clearTimeout(timeout);
                testResults.step5 = { success: false, error: 'JSONP 스크립트 로드 실패' };
                updateStatus(5, 'error', '실패');
                showResult(5, 'JSONP 방식이 지원되지 않습니다.');
                document.head.removeChild(script);
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }

        // 전체 테스트 실행
        async function runAllTests() {
            for (let i = 1; i <= 5; i++) {
                if (i === 5) {
                    testStep5();
                    await new Promise(resolve => setTimeout(resolve, 3000));
                } else {
                    await window[`testStep${i}`]();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            updateSummary();
        }

        // 결과 초기화
        function clearResults() {
            testResults = { step1: null, step2: null, step3: null, step4: null, step5: null };
            for (let i = 1; i <= 5; i++) {
                updateStatus(i, 'pending', '대기중');
                document.getElementById(`step${i}-result`).style.display = 'none';
            }
            document.getElementById('summary').textContent = '';
        }

        // 종합 결과 업데이트
        function updateSummary() {
            const summary = document.getElementById('summary');
            const successCount = Object.values(testResults).filter(r => r && r.success).length;
            const totalCount = Object.values(testResults).filter(r => r !== null).length;
            
            let summaryText = `📊 테스트 완료: ${successCount}/${totalCount} 성공\n\n`;
            
            Object.entries(testResults).forEach(([step, result]) => {
                if (result) {
                    const stepNum = step.replace('step', '');
                    const status = result.success ? '✅' : '❌';
                    summaryText += `${status} ${stepNum}단계: ${result.success ? '성공' : '실패'}\n`;
                }
            });
            
            if (testResults.step1 && testResults.step1.success) {
                summaryText += '\n🎉 GET 요청 성공! API가 작동합니다.';
            }
            
            if (testResults.step4 && testResults.step4.success) {
                summaryText += '\n🚀 POST 요청 성공! CORS 문제 해결됨!';
            } else if (testResults.step3 && testResults.step3.success) {
                summaryText += '\n⚠️ 단순 POST는 작동하지만 JSON POST가 실패. 헤더 문제일 수 있음.';
            }
            
            summary.textContent = summaryText;
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CORS 테스트 도구 준비 완료');
        });
    </script>
</body>
</html>
